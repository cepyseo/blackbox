<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackbox API Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        #response {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 50px;
        }
        #response.loading {
            background: #f5f5f5;
            color: #666;
        }
        #response.error {
            background: #fff0f0;
            color: #d32f2f;
            border-color: #ffa4a4;
        }
    </style>
</head>
<body>
    <div id="response">Waiting for prompt parameter...</div>

    <script>
        async function fetchResponse(prompt, retries = 3) {
            const apiUrl = 'https://www.blackbox.ai/api/chat';
            const headers = {
                'accept': '*/*',
                'accept-language': 'en-US,en;q=0.9',
                'content-type': 'application/json',
                'origin': 'https://www.blackbox.ai',
                'referer': 'https://www.blackbox.ai/',
                'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
            };

            const data = {
                "messages": [{ "role": "user", "content": prompt, "id": "54lcaEJ" }],
                "agentMode": {},
                "id": "RDyqb0u",
                "codeModelMode": true,
                "validated": "00f37b34-a166-4efb-bce5-1312d87f2f94",
                "webSearchModePrompt": true
            };

            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(data),
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    let output = '';
                    let search = [];

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        output += new TextDecoder().decode(value);

                        const match = output.match(/\$~~~\$(.*?)\$~~~\$/);
                        if (match) {
                            try {
                                search = JSON.parse(match[1]);
                                const text = output.replace(match[0], '').split('\n\n\n\n')[1];
                                output = text || '';
                            } catch (e) {
                                console.error('Error parsing search results:', e);
                            }
                        }
                    }

                    return { search, response: output || 'No response content' };
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === retries - 1) {
                        throw new Error(`Failed after ${retries} attempts: ${error.message}`);
                    }
                    // Wait before retrying (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }

        // Get prompt from URL parameter and initialize
        const urlParams = new URLSearchParams(window.location.search);
        const prompt = urlParams.get('p');

        if (prompt) {
            const responseElement = document.getElementById('response');
            responseElement.textContent = 'Loading... Please wait.';
            responseElement.className = 'loading';

            fetchResponse(decodeURIComponent(prompt))
                .then(result => {
                    responseElement.textContent = result.response;
                    responseElement.className = '';
                })
                .catch(error => {
                    responseElement.textContent = `Error: ${error.message}. Please check your network connection and try again.`;
                    responseElement.className = 'error';
                });
        }
    </script>
</body>
</html>