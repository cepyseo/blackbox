<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackbox API Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        #response {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 50px;
        }
        #response.loading {
            background: #f5f5f5;
            color: #666;
        }
        #response.error {
            background: #fff0f0;
            color: #d32f2f;
            border-color: #ffa4a4;
        }
        .status-indicator {
            padding: 8px;
            margin: 10px 0;
            background: #e8f5e9;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="status-indicator" id="status"></div>
    <div id="response">Waiting for prompt parameter...</div>

    <script>
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function generateRandomId(length = 7) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            return Array.from(crypto.getRandomValues(new Uint8Array(length)))
                .map(x => chars[x % chars.length])
                .join('');
        }

        async function fetchResponse(prompt, retries = 3) {
            const apiUrl = 'https://www.blackbox.ai/api/chat';
            const messageId = generateRandomId();
            const sessionId = generateRandomId();
            const validationToken = generateUUID();

            document.getElementById('status').textContent = 'Using generated tokens...';

            const headers = {
                'accept': '*/*',
                'accept-language': 'en-US,en;q=0.9',
                'content-type': 'application/json',
                'origin': 'https://www.blackbox.ai',
                'referer': 'https://www.blackbox.ai/',
            };

            const data = {
                "messages": [{ 
                    "role": "user", 
                    "content": prompt, 
                    "id": messageId 
                }],
                "agentMode": {},
                "id": sessionId,
                "codeModelMode": true,
                "validated": validationToken,
                "webSearchModePrompt": true
            };

            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(data),
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    let output = '';
                    let search = [];

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        output += new TextDecoder().decode(value);

                        const match = output.match(/\$~~~\$(.*?)\$~~~\$/);
                        if (match) {
                            try {
                                search = JSON.parse(match[1]);
                                const text = output.replace(match[0], '').split('\n\n\n\n')[1];
                                output = text || '';
                            } catch (e) {
                                console.error('Error parsing search results:', e);
                            }
                        }
                    }

                    return { search, response: output || 'No response content' };
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === retries - 1) {
                        throw new Error(`Failed after ${retries} attempts: ${error.message}`);
                    }
                    // Wait before retrying (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }

        // Get prompt from URL parameter and initialize
        const urlParams = new URLSearchParams(window.location.search);
        const prompt = urlParams.get('p');

        if (prompt) {
            const responseElement = document.getElementById('response');
            responseElement.textContent = 'Loading... Please wait.';
            responseElement.className = 'loading';

            fetchResponse(decodeURIComponent(prompt))
                .then(result => {
                    responseElement.textContent = result.response;
                    responseElement.className = '';
                })
                .catch(error => {
                    responseElement.textContent = `Error: ${error.message}. Please check your network connection and try again.`;
                    responseElement.className = 'error';
                });
        }
    </script>
</body>
</html>